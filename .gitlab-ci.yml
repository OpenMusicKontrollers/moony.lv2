stages:
  - build
  - test
  - deploy

.common_template: &common_definition
  stage: build
  script:
    - mkdir build
    - pushd build
    - PKG_CONFIG_PATH="/opt/lv2/lib/pkgconfig:/opt/${CI_BUILD_NAME}/lib/pkgconfig" cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX="${CI_PROJECT_DIR}" -DPLUGIN_DEST="$(basename ${CI_PROJECT_DIR})-${CI_BUILD_REF_NAME}/${CI_BUILD_NAME}/$(basename ${CI_PROJECT_DIR})" -DCMAKE_TOOLCHAIN_FILE="${CI_PROJECT_DIR}/cmake/${CI_BUILD_NAME}.cmake" ..
    - cmake .. # needed for multiarch-darwin
    - make
    - make install
  artifacts:
    name: "$(basename ${CI_PROJECT_DIR})-${CI_BUILD_REF_NAME}-${CI_BUILD_NAME}"
    paths:
      - "$(basename ${CI_PROJECT_DIR})-${CI_BUILD_REF_NAME}/"

.native_template: &native_definition
  tags:
    - native 
  <<: *common_definition

.docker_template: &docker_definition
  image: ventosus/crossbuild
  tags:
    - docker
  <<: *common_definition

.test_template: &test_definition
  stage: test
  script:
    - make test

# building natively
x86_64-linux:
  <<: *native_definition

i686-linux:
  <<: *native_definition

# building in docker
x86_64-w64-mingw32:
  <<: *docker_definition

i686-w64-mingw32:
  <<: *docker_definition

arm-linux-gnueabihf:
  <<: *docker_definition

universal-apple-darwin:
  <<: *docker_definition

# testing
x86_64-linux:test:
  <<: *test_definition
  dependencies:
    - x86_64-linux

i686-linux:test:
  <<: *test_definition
  dependencies:
    - i686-linux

x86_64-w64-mingw32:test:
  <<: *test_definition
  dependencies:
    - x86_64-w64-mingw32

i686-w64-mingw32:test:
  <<: *test_definition
  dependencies:
    - i686-w64-mingw32

arm-linux-gnueabihf:test:
  <<: *test_definition
  dependencies:
    - arm-linux-gnueabihf

universal-apple-darwin:test:
  <<: *test_definition
  dependencies:
    - universal-apple-darwin

pack:
  stage: deploy
  tags:
    - native
  script:
    - echo 'packing up...'
  artifacts:
    name: "$(basename ${CI_PROJECT_DIR})-${CI_BUILD_REF_NAME}"
    paths:
      - "$(basename ${CI_PROJECT_DIR})-${CI_BUILD_REF_NAME}/"
